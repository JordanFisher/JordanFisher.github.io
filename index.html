<html>

<head>
    <meta charset="utf-8" />
    <title>Responsive Platformer Joystick Demo</title>
    <style>
        * {
            padding: 0; margin: 0;
        }
        
        html, body {
            overflow: hidden;
        }
        
        canvas {
            background: #eee; display: block; margin: 0 auto;
        }
        
        #info {
            position: fixed;
            left: 0;
            top: 0;
        }
    </style>
</head>

<body>
<canvas id="canvas"></canvas>

<script type="text/javascript">
window.onerror = function(message, url, lineNumber) {  
  alert(message + ' at line ' + lineNumber);
  return true;
}; 

function sign(val) {
    if (val > 0) {
        return 1;
    } else if (val < 0) {
        return -1;
    } else {
        return 0;
    }
}

var w, h;

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

var boxHeight = 60;
var boxWidth = 60;
var playerPos = { x: (canvas.width - boxWidth) / 2, y: 0 };
var playerVel = { x: 0, y: 0 };

var groundHeight = 200;

var upPressed = false, rightPressed = false, leftPressed = false, upReleased = false, rightReleased = false, leftReleased = false;

document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);

function keyDownHandler(e) {
    if (e.keyCode == 39) {
        rightPressed = true;
    } else if (e.keyCode == 37) {
        leftPressed = true;
    } else if (e.keyCode == 38) {
        upPressed = true;
    }
}
function keyUpHandler(e) {
    if (e.keyCode == 39) {
        rightReleased = true;
    } else if (e.keyCode == 37) {
        leftReleased = true;
    } else if (e.keyCode == 38) {
        upReleased = true;
    }
}

function drawPlayer() {
    var xFudge = 0.8, yFudge = 0.55;
    
    ctx.beginPath();
    ctx.rect(xFudge * playerPos.x, h - boxHeight - groundHeight - yFudge * playerPos.y, boxWidth, boxHeight);
    ctx.fillStyle = "#0095DD";
    ctx.fill();
    ctx.closePath();
}

function drawGround() {
    ctx.beginPath();
    ctx.rect(0, h - groundHeight - 5, w, 5);
    ctx.fillStyle = "#0095DD";
    ctx.fill();
    ctx.closePath();
}

var joy_x = 0;
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    joystickUpdate();
    PhsxStep();
    
    drawGround();
    drawPlayer();

    requestAnimationFrame(draw, canvas);
}

function canJump() {
    return playerPos.y <= 0;
}

function jump() {
    playerVel.y = 10;
    playerPos.y = 1;
}

function playerPhsxUpdate() {
    if (rightTouch && canJump()) {
        jump();
    }
    
    playerPos.x += 9 * joy_x;

    if (playerPos.y <= 0) {
        playerVel.y = 0;
    } else {
        playerPos.y += playerVel.y;
        playerVel.y -= 1;
    }
    
    if (playerPos.y < 0) {
        playerPos.y = 0;
    }
}


var OnGround = false, Jumped = false, FallingCount = 0, CountSinceApex = 0,
    ReadyToJump = false, CurJump = 0, JumpDelayCount = 0, Ducking = false,
    StartedJump = false, AccelMod = 1;
var MaxVerticalSpeed_Jump = 23.0;
var BobFallDelay = 5;
var NumJumps = 2;
var JetPack = false;
var Gravity = 2.95;
var BobJumpAccel = (Gravity + 3.45) / 19;
var BobJumpAccel2 = (Gravity + 3.42) / 19;
var JetPackAccel = Gravity * 1.19;
var BobInitialJumpSpeed = 6;
var BobInitialJumpSpeedDucking = 6;
var BobJumpLength = 19;
var BobJumpLengthDucking = 17;
var BobInitialJumpSpeed2 = 14;
var BobInitialJumpSpeedDucking2 = 12;
var BobJumpLength2 = 18;
var BobJumpLengthDucking2 = 17;
var BobFallDelay = 5;
var BobXDunkFriction = 0.63;
var MaxSpeed = 18.2;
var XAccel = .53 * MaxSpeed / 17;
var XFriction = 0.78 * MaxSpeed / 17;
var BobMaxFallSpeed = -29;
var DoFastTakeOff = true;
var ReverseDirectionBoost = 2.7;
var ReverseDirectionBoostMod = 1;
var JumpDelay = 10;
var JumpLengthModifier = 1;
var MaxJumpAccelMultiple = 1, JumpAccelModifier = 1;
MaxSpeed = 17.2;
MaxSpeed *= 1.04;
XAccel *= 1.1175;

function MyPhsx_PhsxStep() {
    DoXAccel();
    DoYAccel();

    if (OnGround) Jumped = false;

    if (OnGround && FallingCount > 0) {
        FallingCount = 0;
    } else {
        FallingCount++;
        CountSinceApex++;
    }            

    Jump();

    OnGround = false;
}

function DynamicGreaterThan(val1, val2) {
    return Gravity > 0 ? val1 > val2 : val1 < -val2;
}

function UpdateReadyToJump() {
    // Update ReadyToThrust
    if (JetPack && !OnGround && (!rightTouch || !StartedJump)) {
        ReadyToThrust = true;
    } else {
        ReadyToThrust = false;
    }
}
        
function CanJump() {
    return ReadyToJump && (playerVel.y < MaxVerticalSpeed_Jump) &&
        (OnGround || FallingCount < BobFallDelay ||
         CurJump < NumJumps && JumpDelayCount <= 0 && CurJump > 0);
}

function Jump() {
    JumpDelayCount--;

    UpdateReadyToJump();

    if (CanJump() && rightTouch) {
        DoJump();
    }
}

function DoJump() {
    if (OnGround || FallingCount < BobFallDelay + 5) {
        CurJump = 0;
    }

    Jumped = true;

    StartJumpAnim = true;

    CurJump++;
    JumpDelayCount = JumpDelay;

    ReadyToJump = false;

    FallingCount = 1000;

    var speed;
    if (CurJump == 1) {
        if (!Ducking) {
            speed = BobInitialJumpSpeed;
            JumpCount = BobJumpLength;
        } else {
            speed = BobInitialJumpSpeedDucking;
            JumpCount = BobJumpLengthDucking;
        }
    } else {
        if (!Ducking) {
            speed = BobInitialJumpSpeed2;
            JumpCount = BobJumpLength2;
        } else {
            speed = BobInitialJumpSpeedDucking2;
            JumpCount = BobJumpLengthDucking2;
        }
    }

    JumpCount = Math.floor(JumpCount * JumpLengthModifier);

    if (Gravity > 0 && playerVel.y > 0 && CurJump == 1 ||
        Gravity < 0 && playerVel.y < 0 && CurJump == 1) {
        max = playerVel.y + JumpAccelModifier * speed;
        min = MaxJumpAccelMultiple * speed;
        playerVel.y = CoreMath.Restrict(min, max, playerVel.y);
    } else {
        playerVel.y = JumpAccelModifier * speed;
    }
        
    StartedJump = true;

    ApexReached = false;
    ApexY = -20000000;
}
        
function DoXAccel() {
    accel = XAccel;
    accel *= AccelMod;

    if (joy_x < -0.15 && playerVel.x > -MaxSpeed) {
        if (playerVel.x <= 0) {
            playerVel.x += accel * joy_x;
        } else {
            if (!(Ducking && OnGround)) {
                playerVel.x += ReverseDirectionBoost * ReverseDirectionBoostMod * accel * joy_x;
            }
        }

        if (DoFastTakeOff && playerVel.x < 0 && playerVel.x > -MaxSpeed / 10) {
            playerVel.x = -MaxSpeed / 10;
        }
    }
    
    if (joy_x > 0.15 && playerVel.x < MaxSpeed) {
        if (playerVel.x >= 0) {
            playerVel.x += accel * joy_x;
        } else {
            if (!(Ducking && OnGround)) {
                playerVel.x += ReverseDirectionBoost * ReverseDirectionBoostMod * accel * joy_x;
            }
        }

        if (DoFastTakeOff && playerVel.x > 0 && playerVel.x < MaxSpeed / 10) {
            playerVel.x = MaxSpeed / 10;
        }
    }

    var Run = false;
    if (Math.abs(joy_x) < 0.15 || !Run && Math.abs(playerVel.x) > MaxSpeed || (Ducking && (OnGround || FallingCount < 2))) {
        if (Ducking && (OnGround || FallingCount < 2) && Math.abs(playerVel.x) < 2) playerVel.x = 0;

        fric = XFriction;
        if (Ducking && (OnGround || FallingCount < 2)) fric = BobXDunkFriction;

        if (Math.abs(playerVel.x) < 2) {
            playerVel.x /= 12.0;
        } else {
            Prev_xVel = playerVel.x;
            playerVel.x -= sign(playerVel.x) * 7.0 / 4.0 * fric;

            if (!Ducking) {
                // If we were above max speed do not reduce below max speed this frame if xVec.x > 0
                if (Math.abs(Prev_xVel) >= MaxSpeed && Math.abs(playerVel.x) < MaxSpeed) {
                    playerVel.x = sign(playerVel.x) * MaxSpeed * 0.999;
                }
            }
        }
    }
}

function DoYAccel() {
    Thrusting = false;
    if (JetPack && (ReadyToThrust || Thrusting))
    if (CurJump >= NumJumps && JumpDelayCount <= 0 || !OnGround && CurJump == 0 && FallingCount >= BobFallDelay) {
        if (rightTouch && JetPackCount < JetPackLength + JetPackCushion) {
            Thrusting = true;
            JetPackCount++;
            PowerLossRatio = float(JetPackLength + JetPackCushion - JetPackCount) / float(JetPackCushion);
            PowerLossRatio = Math.Min(1, PowerLossRatio);
            
            if (playerVel.y < MaxVerticalSpeed_Thrust) {
                playerVel.y += JetPackAccel * PowerLossRatio;
            }
        }
    }

    if (StartedJump && rightTouch && JumpCount > 0) {
        if (CurJump == 1) {
            playerVel.y += BobJumpAccel * JumpCount;
        } else {
            playerVel.y += BobJumpAccel2 * JumpCount;
        }
            
        JumpCount -= 1;
    } else {
        StartedJump = false;
    }

    if (StartedJump || (FallingCount >= BobFallDelay || Ducking)) {
        HoldVel = playerVel.y;

        // Only apply gravity if we haven't reached terminal velocity
        if (DynamicGreaterThan(playerVel.y, BobMaxFallSpeed)) {
            playerVel.y -= Gravity;
        }

        if (sign(HoldVel) != sign(playerVel.y)) {
            ApexReached = true;
            ApexY = playerPos.y;
            CountSinceApex = 0;
        }
    }

    if (!Thrusting) {
        ThrustSoundCount = 0;
    }
}

function LandOnSomething(MakeReadyToJump) {
    ReadyToJump = ReadyToJump || MakeReadyToJump;

    OnGround = true;

    CurJump = 1;
    JetPackCount = 0;
}

function Integrate() {
    playerPos.x += playerVel.x;
    playerPos.y += playerVel.y;
}

function PhsxStep() {
    MyPhsx_PhsxStep();

    // Integrate velocity
    Integrate();

    //BlockInteractions();
    if (playerPos.y < 0) {
        LandOnSomething(true);
        playerPos.y = 0;
    }
}


function setCanvasSize() {
    canvas.width = document.body.clientWidth;
    canvas.height = document.body.clientHeight;
    w = canvas.width;
    h = canvas.height;
    
    setTimeout(function() {
        window.scrollTo(0, 0);
    }, 0);
}

//screen.orientation.lock('landscape');
window.onresize = setCanvasSize;
setCanvasSize();

var joyTouch, joyCenter, touchCenterX, touchCenterY, touchX;
var maxThreshold = 4, minThreshold = 3;
var joyHadTouchEvent = false;
var rightTouch;

function joystickUpdate() {
    if (upPressed) {
        rightTouch = true;
    }
    
    if (upReleased) {
        rightTouch = false;
    }

    if (rightPressed) {
        joy_x = 1;
    }

    if (leftPressed) {
        joy_x = -1;
    }
    
    if (leftReleased || rightReleased) {
        joy_x = 0;
    }
    
    if (joyTouch && joy_x === 0 && !joyHadTouchEvent) {
        var s = 0.85, t = 1 - s;

        joyCenter = s * joyCenter + t * touchX;
        maxThreshold = s * maxThreshold + t * 4;
        minThreshold = s * minThreshold + t * 3;
    }
    
    joyHadTouchEvent = false;
    
    upPressed = leftPressed = rightPressed = false;
    upReleased = leftReleased = rightReleased = false;
}

function handleStart(e) {
    e.preventDefault();
    
    var touches = e.changedTouches;
    for (var i = 0; i < touches.length; i++) {
        var touch = touches[i];
        if (!joyTouch && touch.screenX < w / 2) {
            joyTouch = touch;
            joyCenter = joyTouch.screenX;
            touchCenterX = joyTouch.screenX;
            touchCenterY = joyTouch.screenY;
            touchX = touchCenterX;
        } else if (!rightTouch && touch.screenX > w / 2) {
            rightTouch = touch;
        }
    }
}

function handleMove(e) {
    e.preventDefault();
    
    var touches = e.changedTouches;
    for (var i = 0; i < touches.length; i++) {
        var touch = touches[i];
        
        if (joyTouch && touch.identifier === joyTouch.identifier) {
            joyHadTouchEvent = true;
            joyTouch = touch;

            var changeX = joyTouch.screenX - touchCenterX;
            var changeY = Math.abs(joyTouch.screenY - touchCenterY);
            if (changeY > changeX) changeY = changeX;
            var deltaX = sign(changeX) * Math.sqrt(changeX*changeX + changeY*changeY);
            touchX += deltaX;
            
            touchCenterX = joyTouch.screenX;
            touchCenterY = joyTouch.screenY;

            //info.textContent = touchX + '<br />' + joyCenter;
            
            var diff = touchX - joyCenter;

            if (diff > maxThreshold) {
                minThreshold = 11; maxThreshold = 12;
                joyCenter = touchX - maxThreshold;
            } else if (diff < -maxThreshold) {
                minThreshold = 11; maxThreshold = 12;
                joyCenter = touchX + maxThreshold;
            }
            
            if (diff > minThreshold) {
                if (diff > maxThreshold) {
                    joy_x = 1;
                } else {
                    joy_x = 1;
                }
            } else if (diff < -minThreshold) {
                if (diff < -maxThreshold) {
                    joy_x = -1;
                } else {
                    joy_x = -1;
                }
            } else {
                joy_x = 0;
            }
        }
        else if (rightTouch && touch.identifier === rightTouch.identifier) {
            rightTouch = touch;
        }
    }
}

function handleEnd(e) {
    e.preventDefault();
    
    var touches = e.changedTouches;
    for (var i = 0; i < touches.length; i++) {
        var touch = touches[i];
        
        if (joyTouch && touch.identifier === joyTouch.identifier) {
            joyTouch = undefined;
            joy_x = 0;
        } else if (rightTouch && touch.identifier === rightTouch.identifier) {
            rightTouch = undefined;
        }
    }
}

canvas.addEventListener("touchstart", handleStart, false);
canvas.addEventListener("touchmove", handleMove, false);
canvas.addEventListener("touchend", handleEnd, false);
canvas.addEventListener("touchcancel", handleEnd, false);

draw();
</script>    
</body>

</html>
